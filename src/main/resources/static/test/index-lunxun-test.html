<!DOCTYPE html>
<html lang="zh">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è½®è¯¢é“¾æ¥è·å–æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        min-height: 100vh;
      }
      .container {
        max-width: 900px;
        margin: 0 auto;
        background: rgba(255, 255, 255, 0.1);
        padding: 30px;
        border-radius: 15px;
        -webkit-backdrop-filter: blur(10px);
        backdrop-filter: blur(10px);
      }
      .status {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 8px;
        margin: 10px 0;
        font-family: monospace;
        max-height: 300px;
        overflow-y: auto;
      }
      .success {
        color: #4ade80;
      }
      .warning {
        color: #fbbf24;
      }
      .error {
        color: #f87171;
      }
      .info {
        color: #60a5fa;
      }
      .timer {
        font-size: 2em;
        text-align: center;
        margin: 20px 0;
        font-weight: bold;
      }
      .progress-bar {
        width: 100%;
        height: 20px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        overflow: hidden;
        margin: 10px 0;
      }
      .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #4ade80, #22c55e);
        width: 0%;
        transition: width 0.3s ease;
      }
      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
        margin: 20px 0;
      }
      .stat-card {
        background: rgba(255, 255, 255, 0.1);
        padding: 15px;
        border-radius: 8px;
        text-align: center;
      }
      .stat-value {
        font-size: 1.5em;
        font-weight: bold;
        color: #4ade80;
      }
      .stat-label {
        font-size: 0.9em;
        opacity: 0.8;
      }
      .link-display {
        background: rgba(0, 0, 0, 0.3);
        padding: 15px;
        border-radius: 8px;
        margin: 15px 0;
        word-break: break-all;
      }
      .link-display a {
        color: #4ade80;
        text-decoration: none;
      }
      .link-display a:hover {
        text-decoration: underline;
      }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mobile-detect/1.4.5/mobile-detect.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ua-parser-js@2.0.0-beta.2/dist/ua-parser.min.js"></script>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ”„ è½®è¯¢é“¾æ¥è·å–æµ‹è¯•</h1>
      <p>è¿™ä¸ªé¡µé¢æ¼”ç¤ºäº†ä¼˜åŒ–çš„è½®è¯¢é“¾æ¥è·å–åŠŸèƒ½</p>
      <p>
        <strong>æ³¨æ„ï¼š</strong
        >protectGetLinkæ¥å£ä¼šè‡ªåŠ¨å¼‚æ­¥è®°å½•è®¿é—®æ•°æ®ï¼Œæ— éœ€é¢å¤–è°ƒç”¨
      </p>

      <div class="timer" id="timer">0.00ms</div>
      <div class="progress-bar">
        <div class="progress-fill" id="progress"></div>
      </div>

      <div class="stats">
        <div class="stat-card">
          <div class="stat-value" id="ipTime">-</div>
          <div class="stat-label">IPè·å–è€—æ—¶</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="linkTime">-</div>
          <div class="stat-label">é“¾æ¥è·å–è€—æ—¶</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="jumpTime">-</div>
          <div class="stat-label">è·³è½¬è€—æ—¶</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalTime">-</div>
          <div class="stat-label">æ€»è€—æ—¶</div>
        </div>
      </div>

      <div id="linkResult" class="link-display" style="display: none">
        <h3>è·å–åˆ°çš„è½®è¯¢é“¾æ¥ï¼š</h3>
        <div id="linkContent"></div>
        <div id="keyContent" style="margin-top: 10px"></div>
      </div>

      <div id="status" class="status">
        <div class="info">â³ æ­£åœ¨åˆå§‹åŒ–...</div>
      </div>

      <button
        onclick="testLunxun()"
        style="
          background: #4ade80;
          color: white;
          border: none;
          padding: 15px 30px;
          border-radius: 8px;
          font-size: 16px;
          cursor: pointer;
          margin: 10px 5px;
        "
      >
        ğŸ”„ æµ‹è¯•è½®è¯¢é“¾æ¥è·å–
      </button>

      <button
        onclick="testWithJump()"
        style="
          background: #fbbf24;
          color: white;
          border: none;
          padding: 15px 30px;
          border-radius: 8px;
          font-size: 16px;
          cursor: pointer;
          margin: 10px 5px;
        "
      >
        ğŸš€ æµ‹è¯•è·å–å¹¶è·³è½¬
      </button>

      <button
        onclick="clearStatus()"
        style="
          background: #f87171;
          color: white;
          border: none;
          padding: 15px 30px;
          border-radius: 8px;
          font-size: 16px;
          cursor: pointer;
          margin: 10px 5px;
        "
      >
        ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—
      </button>
    </div>

    <script>
      let startTime, ipTime, linkTime, jumpTime, totalTime;

      function updateStatus(message, type = "info") {
        const status = document.getElementById("status");
        const className =
          type === "success"
            ? "success"
            : type === "warning"
            ? "warning"
            : type === "error"
            ? "error"
            : "info";
        status.innerHTML += `<div class="${className}">${new Date().toLocaleTimeString()} - ${message}</div>`;
        status.scrollTop = status.scrollHeight;
      }

      function updateProgress(percent) {
        document.getElementById("progress").style.width = percent + "%";
      }

      function updateTimer() {
        if (startTime) {
          const elapsed = performance.now() - startTime;
          document.getElementById("timer").textContent =
            elapsed.toFixed(2) + "ms";
        }
      }

      function generateSessionId() {
        return (
          "test_lunxun_" +
          Date.now() +
          "_" +
          Math.random().toString(36).substr(2, 9)
        );
      }

      function collectDeviceInfo() {
        const md = new MobileDetect(window.navigator.userAgent);
        const urlParams = new URLSearchParams(window.location.search);
        const hasQueryParams = urlParams.toString() !== "";
        const parser = new UAParser();
        const resultPar = parser.getResult();

        const deviceType = md.mobile() ? "Mobile" : "PC";
        const isMobile = md.mobile() !== null || md.tablet() !== null;
        const isIOS = md.is("iOS")
          ? "iOS"
          : md.is("AndroidOS")
          ? "Android"
          : "Other";
        const userAgent = navigator.userAgent;
        const screenWidth = window.screen.width;
        const screenHeight = window.screen.height;
        const pixelRatio = window.devicePixelRatio;
        const timezoneName = Intl.DateTimeFormat().resolvedOptions().timeZone;
        const continent = timezoneName.split("/")[0];
        const userLanguage = navigator.language || navigator.userLanguage;

        let codefb = "";
        if (urlParams.get("utm_source") === "fb" && urlParams.has("fbclid")) {
          codefb = "Facebookå¹¿å‘Šè®¿é—®çš„ã€‚";
        } else if (urlParams.has("fbclid")) {
          codefb = "Facebooké“¾æ¥è®¿é—®çš„ã€‚";
        } else if (urlParams.get("utm_source") === "fb") {
          codefb = "Facebookå¹¿å‘Šè®¿é—®çš„ã€‚";
        } else if (urlParams.has("ttclid")) {
          codefb = "TikToké“¾æ¥è®¿é—®çš„ã€‚";
        } else {
          codefb = "ä¸æ˜¯Facebookæˆ–TikTok";
        }

        // è·å–è®¾å¤‡å‹å·
        const modelSM = resultPar.device.model;
        let isSamsung = "Not Samsung";
        if (modelSM && modelSM.startsWith("SM-G")) {
          const modelNumber = parseInt(modelSM.match(/\d+/)[0], 10);
          if (modelNumber < 960) {
            isSamsung = "BannedSamsung";
          } else {
            isSamsung = "Samsung";
          }
        }

        return {
          domainName: window.location.host + window.location.pathname,
          userMobile: deviceType,
          paraPath: hasQueryParams,
          isIOSS: isIOS,
          fb: codefb,
          screenWidth: screenWidth,
          screenHeight: screenHeight,
          pixelRatio: pixelRatio,
          continent: continent,
          isMobile: isMobile,
          userLanguage: userLanguage,
          userAgent: userAgent,
          isSamsung: isSamsung,
          timestamp: new Date().toISOString(),
          sessionId: generateSessionId(),
        };
      }

      async function testLunxun() {
        startTime = performance.now();
        updateStatus("ğŸ”„ å¼€å§‹è½®è¯¢é“¾æ¥è·å–æµ‹è¯•...", "info");
        updateProgress(10);

        const data = collectDeviceInfo();
        updateProgress(20);
        updateStatus("ğŸ“± è®¾å¤‡ä¿¡æ¯æ”¶é›†å®Œæˆ", "success");

        try {
          // ç¬¬ä¸€æ­¥ï¼šè·å–IPåœ°å€
          const ipStart = performance.now();
          updateStatus("ğŸŒ å¼€å§‹è·å–IPåœ°å€...", "info");

          const ipDataResponse = await fetch("get_ip_info.php").catch(() =>
            fetch("https://ipapi.co/json/")
          );
          const ipData = await ipDataResponse.json();
          const ip = ipData.ip;

          ipTime = performance.now() - ipStart;
          updateStatus(
            `âœ… IPè·å–å®Œæˆï¼Œè€—æ—¶: ${ipTime.toFixed(2)}msï¼ŒIP: ${ip}`,
            "success"
          );
          updateProgress(40);

          // ç¬¬äºŒæ­¥ï¼šè·å–è½®è¯¢é“¾æ¥
          const linkStart = performance.now();
          updateStatus("ğŸ”— å¼€å§‹è·å–è½®è¯¢é“¾æ¥...", "info");

          const response = await fetch(
            "http://127.0.0.1:3031/fbVpnStock/protectGetLink",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                ...data,
                userIp: ip,
              }),
            }
          );

          const responseData = await response.json();
          linkTime = performance.now() - linkStart;

          if (
            responseData.success &&
            responseData.data &&
            responseData.data.link
          ) {
            updateStatus(
              `âœ… è½®è¯¢é“¾æ¥è·å–æˆåŠŸï¼Œè€—æ—¶: ${linkTime.toFixed(2)}ms`,
              "success"
            );
            updateProgress(80);

            // æ˜¾ç¤ºè·å–åˆ°çš„é“¾æ¥
            document.getElementById("linkResult").style.display = "block";
            document.getElementById("linkContent").innerHTML = `
              <strong>é“¾æ¥:</strong> <a href="${responseData.data.link}" target="_blank">${responseData.data.link}</a>
            `;
            document.getElementById("keyContent").innerHTML = `
              <strong>Key:</strong> ${responseData.data.key || "æ— "}
            `;

            totalTime = performance.now() - startTime;
            updateProgress(100);

            // æ›´æ–°ç»Ÿè®¡
            document.getElementById("ipTime").textContent =
              ipTime.toFixed(2) + "ms";
            document.getElementById("linkTime").textContent =
              linkTime.toFixed(2) + "ms";
            document.getElementById("totalTime").textContent =
              totalTime.toFixed(2) + "ms";

            updateStatus(
              `ğŸ‰ æµ‹è¯•å®Œæˆï¼æ€»è€—æ—¶: ${totalTime.toFixed(2)}ms`,
              "success"
            );
            updateStatus("ğŸ’¡ è½®è¯¢é“¾æ¥è·å–æˆåŠŸï¼Œå¯ä»¥è¿›è¡Œè·³è½¬æµ‹è¯•", "info");
          } else {
            updateStatus(
              `âŒ è½®è¯¢é“¾æ¥è·å–å¤±è´¥: ${JSON.stringify(responseData)}`,
              "error"
            );
            updateProgress(100);
          }
        } catch (error) {
          updateStatus(`âŒ æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
          updateProgress(100);
        }
      }

      async function testWithJump() {
        startTime = performance.now();
        updateStatus("ğŸš€ å¼€å§‹è·å–å¹¶è·³è½¬æµ‹è¯•...", "info");
        updateProgress(10);

        const data = collectDeviceInfo();
        updateProgress(20);

        try {
          // è·å–IPåœ°å€
          const ipStart = performance.now();
          const ipDataResponse = await fetch("get_ip_info.php").catch(() =>
            fetch("https://ipapi.co/json/")
          );
          const ipData = await ipDataResponse.json();
          const ip = ipData.ip;

          ipTime = performance.now() - ipStart;
          updateStatus(
            `âœ… IPè·å–å®Œæˆï¼Œè€—æ—¶: ${ipTime.toFixed(2)}ms`,
            "success"
          );
          updateProgress(40);

          // è·å–è½®è¯¢é“¾æ¥
          const linkStart = performance.now();
          const response = await fetch(
            "http://127.0.0.1:3031/fbVpnStock/protectGetLink",
            {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                ...data,
                userIp: ip,
              }),
            }
          );

          const responseData = await response.json();
          linkTime = performance.now() - linkStart;

          if (
            responseData.success &&
            responseData.data &&
            responseData.data.link
          ) {
            updateStatus(
              `âœ… è½®è¯¢é“¾æ¥è·å–æˆåŠŸï¼Œè€—æ—¶: ${linkTime.toFixed(2)}ms`,
              "success"
            );
            updateProgress(70);

            // è·³è½¬
            const jumpStart = performance.now();
            updateStatus("âš¡ å¼€å§‹è·³è½¬åˆ°è½®è¯¢é“¾æ¥...", "warning");

            // æ¨¡æ‹Ÿè·³è½¬ï¼ˆå®é™…æµ‹è¯•æ—¶æ›¿æ¢ä¸ºçœŸå®è·³è½¬ï¼‰
            setTimeout(() => {
              jumpTime = performance.now() - jumpStart;
              totalTime = performance.now() - startTime;

              document.getElementById("jumpTime").textContent =
                jumpTime.toFixed(2) + "ms";
              document.getElementById("totalTime").textContent =
                totalTime.toFixed(2) + "ms";

              updateStatus(
                `âœ… è·³è½¬å®Œæˆï¼Œè·³è½¬è€—æ—¶: ${jumpTime.toFixed(2)}ms`,
                "success"
              );
              updateStatus(
                `ğŸ‰ æ€»è€—æ—¶: ${totalTime.toFixed(2)}msï¼Œç›®æ ‡é“¾æ¥: ${
                  responseData.data.link
                }`,
                "success"
              );
              updateStatus("ğŸ’¡ å®é™…ç¯å¢ƒä¸­ä¼šç«‹å³è·³è½¬åˆ°ç›®æ ‡é“¾æ¥", "info");

              updateProgress(100);
            }, 100);
          } else {
            updateStatus(`âŒ è½®è¯¢é“¾æ¥è·å–å¤±è´¥ï¼Œæ— æ³•è·³è½¬`, "error");
            updateProgress(100);
          }
        } catch (error) {
          updateStatus(`âŒ è·³è½¬æµ‹è¯•å¤±è´¥: ${error.message}`, "error");
          updateProgress(100);
        }
      }

      function clearStatus() {
        document.getElementById("status").innerHTML =
          '<div class="info">æ—¥å¿—å·²æ¸…ç©º</div>';
        document.getElementById("linkResult").style.display = "none";
        document.getElementById("progress").style.width = "0%";
        document.getElementById("timer").textContent = "0.00ms";

        // é‡ç½®ç»Ÿè®¡
        document.getElementById("ipTime").textContent = "-";
        document.getElementById("linkTime").textContent = "-";
        document.getElementById("jumpTime").textContent = "-";
        document.getElementById("totalTime").textContent = "-";
      }

      // å¯åŠ¨å®šæ—¶å™¨
      setInterval(updateTimer, 16); // 60fps

      // é¡µé¢åŠ è½½å®Œæˆ
      updateStatus("âœ… é¡µé¢åŠ è½½å®Œæˆï¼Œå¯ä»¥å¼€å§‹æµ‹è¯•", "success");
    </script>
  </body>
</html>
